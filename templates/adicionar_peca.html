{% extends "base.html" %}

{% block title %}Adicionar Nova Peça{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .similar-search-container { position: relative; }
        .similar-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        .similar-result-item { padding: 8px 12px; cursor: pointer; }
        .similar-result-item:hover { background-color: #f0f0f0; }
        .selected-similar-list { margin-top: 10px; }
        .selected-similar-item { display: flex; justify-content: space-between; align-items: center; background-color: #e9ecef; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; }
        .remove-similar-btn { cursor: pointer; color: #dc3545; font-weight: bold; background: none; border: none; font-size: 1.2em; }
        .validation-message { font-size: 0.9em; margin-top: 5px; }
        .validation-message.success { color: #28a745; }
        .validation-message.error { color: #dc3545; }
    </style>
{% endblock %}

{% block content %}
<div id="page-root" 
    data-product-id="" 
    data-get-montadora-url="{{ url_for('main.get_montadora_for_veiculo') }}"
    data-similar-search-url="{{ url_for('main.buscar_pecas_similares') }}"
    data-check-codigo-url="{{ url_for('main.check_codigo') }}"
>

    <header>
        <h1>Adicionar Nova Peça</h1>
    </header>

    <form action="{{ url_for('admin.adicionar_peca') }}" method="POST" enctype="multipart/form-data" class="search-section" novalidate>

            <div class="search-field">
                <label for="nome">Nome da Peça</label>
                <input type="text" id="nome" name="nome" class="form-control" required>
            </div>
            <div class="search-field">
                <label for="codigo">Código</label>
                <input type="text" id="codigo" name="codigo" class="form-control" required>
                <div id="codigo-validation-message" class="validation-message"></div>
            </div>
            
            <datalist id="montadoras-lista">
                {% for fab_item in montadoras %}
                    <option value="{{ fab_item }}">
                {% endfor %}
            </datalist>

            <div class="search-field">
                <label for="fornecedor">Fornecedor</label>
                <input type="text" id="fornecedor" name="fornecedor" list="fornecedores-lista" autocomplete="off">
                <datalist id="fornecedores-lista">
                    {% for forn_item in fornecedores %}
                        <option value="{{ forn_item }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="search-field">
                <label for="grupo">Grupo</label>
                <input type="text" id="grupo" name="grupo" list="grupos-lista" autocomplete="off">
                <datalist id="grupos-lista">
                    {% for grupo_item in grupos %}
                        <option value="{{ grupo_item }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="search-field" style="width: 100%;">
                <h4 style="margin-bottom: 10px; color: #333;">Medidas</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <label for="largura">Largura (mm)</label>
                        <input type="text" id="largura" name="largura" placeholder="Ex: 50">
                    </div>
                    <div>
                        <label for="altura">Altura (mm)</label>
                        <input type="text" id="altura" name="altura" placeholder="Ex: 30">
                    </div>
                    <div>
                        <label for="comprimento">Comprimento (mm)</label>
                        <input type="text" id="comprimento" name="comprimento" placeholder="Ex: 200">
                    </div>
                    <div>
                        <label for="diametro_externo">Diâmetro Externo (mm)</label>
                        <input type="text" id="diametro_externo" name="diametro_externo" placeholder="Ex: 100">
                    </div>
                    <div>
                        <label for="diametro_interno">Diâmetro Interno (mm)</label>
                        <input type="text" id="diametro_interno" name="diametro_interno" placeholder="Ex: 80">
                    </div>
                    <div>
                        <label for="elo">Elo</label>
                        <input type="text" id="elo" name="elo" placeholder="Ex: 12">
                    </div>
                    <div>
                        <label for="estrias_internas">Estrias Internas</label>
                        <input type="text" id="estrias_internas" name="estrias_internas" placeholder="Ex: 24">
                    </div>
                    <div>
                        <label for="estrias_externas">Estrias Externas</label>
                        <input type="text" id="estrias_externas" name="estrias_externas" placeholder="Ex: 26">
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label for="medidas_adicionais">Medidas Adicionais</label>
                    <textarea id="medidas_adicionais" name="medidas_adicionais" rows="2" placeholder="Outras medidas ou observações sobre dimensões"></textarea>
                </div>
            </div>

            <!-- Seção de Aplicações Dinâmicas -->
            <div id="aplicacoes-container" style="width: 100%;">
                <!-- O JavaScript irá adicionar os blocos de aplicação aqui -->
            </div>
            <button type="button" id="add-aplicacao-btn" style="background-color: #17a2b8; margin-top: 19px; margin-bottom: 20px;">Adicionar aplicação</button>

            <!-- Campo de busca para Códigos Similares -->
            <div class="search-field" style="width: 48%;">
                <label for="similar-search">Buscar Códigos Similares:</label>
                <div class="similar-search-container">
                    <input type="text" id="similar-search" placeholder="Digite código ou nome para buscar..." autocomplete="off">
                    <div id="similar-search-loader" class="loader"></div>
                    <div id="similar-results" class="similar-results"></div>
                </div>
                <div id="selected-similar-list" class="selected-similar-list"></div>
                <input type="hidden" id="similares_ids" name="similares_ids">
            </div>

            <!-- Seção de Conversões -->
            <div class="search-field" style="width: 100%;">
                <label for="conversoes">Nº Conversão</label>
                <textarea id="conversoes" name="conversoes" rows="8"></textarea>
            </div>

            <div class="search-field" style="width: 100%;">
                <label for="observacoes">Observações</label>
                <textarea id="observacoes" name="observacoes" rows="4"></textarea>
            </div>

            <div class="search-field">
                <label for="imagens">Adicionar Novas Imagens</label>
                <input type="file" id="imagens" name="imagens" multiple accept="image/*">
                <div id="new-image-preview-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
                
                <hr style="margin: 15px 0;">

                <label for="imagem_url">Ou Adicionar Imagem por URL</label>
                <input type="url" id="imagem_url" name="imagem_url" placeholder="https://exemplo.com/imagem.jpg" style="width: 100%; box-sizing: border-box;">
            </div>
            
            <button type="submit" class="button">Adicionar Peça</button>
            <a href="{{ url_for('main.index') }}" class="button" style="background-color: #555; color: white; padding: 12px 20px; text-decoration: none; border-radius: 4px;">Cancelar</a>
        </form>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {# Reutiliza os mesmos scripts de editar_peca.html, com pequenas adaptações #}
    <script>
        // Script para adicionar/remover blocos de aplicação
        document.getElementById('add-aplicacao-btn').addEventListener('click', function() {
            const container = document.getElementById('aplicacoes-container');
            const index = container.getElementsByClassName('aplicacao-bloco').length;
            
            const novoBloco = document.createElement('div');
            novoBloco.classList.add('aplicacao-bloco');
            novoBloco.style.marginTop = '20px';
            novoBloco.dataset.index = index;
            novoBloco.innerHTML = `
                <h4 style="width: 100%; margin-top: 0;">Nova Aplicação ${index + 1}</h4>
                <div class="search-field"><label for="aplicacoes-${index}-veiculo">Veículo:</label><input type="text" id="aplicacoes-${index}-veiculo" name="aplicacoes-${index}-veiculo"></div>
                <div class="search-field"><label for="aplicacoes-${index}-ano">Ano:</label><input type="text" id="aplicacoes-${index}-ano" name="aplicacoes-${index}-ano"></div>
                <div class="search-field"><label for="aplicacoes-${index}-motor">Motor:</label><input type="text" id="aplicacoes-${index}-motor" name="aplicacoes-${index}-motor"></div>
                <div class="search-field"><label for="aplicacoes-${index}-conf_mtr">Conf. MTR:</label><input type="text" id="aplicacoes-${index}-conf_mtr" name="aplicacoes-${index}-conf_mtr"></div>
                <div class="search-field"><label for="aplicacoes-${index}-montadora">Montadora:</label><input type="text" id="aplicacoes-${index}-montadora" name="aplicacoes-${index}-montadora" list="montadoras-lista" autocomplete="off"></div>
                <div style="width: 100%; text-align: right;"><button type="button" class="remove-aplicacao-btn" style="background-color: #dc3545; font-size: 0.9em; padding: 8px 12px;">Remover</button></div>
            `;
            
            container.appendChild(novoBloco);
        });

        document.getElementById('aplicacoes-container').addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-aplicacao-btn')) {
                e.target.closest('.aplicacao-bloco').remove();
            }
        });

        // --- Validação de Código em Tempo Real (Adição) ---
        const codigoInput = document.getElementById('codigo');
        const validationMessage = document.getElementById('codigo-validation-message');
        let debounceTimer;

        codigoInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const codigo = this.value.trim();
            if (codigo.length < 3) { 
                validationMessage.textContent = ''; 
                validationMessage.className = 'validation-message';
                return; 
            }

            debounceTimer = setTimeout(() => {
                const checkUrl = document.getElementById('page-root').dataset.checkCodigoUrl;
                fetch(`${checkUrl}?codigo=${encodeURIComponent(codigo)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            validationMessage.textContent = `Atenção: Código já em uso pelo produto "${data.nome}".`;
                            validationMessage.className = 'validation-message error';
                        } else {
                            validationMessage.textContent = 'Código disponível!';
                            validationMessage.className = 'validation-message success';
                        }
                    });
            }, 500);
        });

        // --- Lógica para autocompletar montadora ---
        function handleVeiculoBlur(event) {
            const veiculoInput = event.target;
            // Garante que o evento só seja acionado para inputs de veículo
            if (!veiculoInput.name.endsWith('-veiculo')) return;

            const veiculoNome = veiculoInput.value.trim();
            if (veiculoNome.length < 3) return;

            const aplicacaoBloco = veiculoInput.closest('.aplicacao-bloco');
            const montadoraInput = aplicacaoBloco.querySelector('input[name$="-montadora"]');
            const getMontadoraUrl = document.getElementById('page-root').dataset.getMontadoraUrl;

            // Só preenche se o campo montadora estiver vazio
            if (montadoraInput && !montadoraInput.value && getMontadoraUrl) {
                fetch(`${getMontadoraUrl}?veiculo=${encodeURIComponent(veiculoNome)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.montadora) { montadoraInput.value = data.montadora; }
                    });
            }
        }
        document.getElementById('aplicacoes-container').addEventListener('blur', handleVeiculoBlur, true);
    </script>
    {# Inclui os scripts de editar_peca.html que são reutilizáveis #}
    <script src="{{ url_for('static', filename='js/form_helpers.js') }}"></script>
</div>
{% endblock %}