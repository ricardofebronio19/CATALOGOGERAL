{% extends "base.html" %}

{% block title %}Resultados da Busca{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
    <header>
        <div class="results-header">
            <h1>Resultados da Busca</h1>
            {% if is_admin %}
                <a class="button" href="{{ url_for('admin.exportar_csv', **search_args) }}" target="_blank">Exportar resultados para CSV</a>
            {% endif %}
        </div>
    </header>

    <div class="results-summary">
        <p>
            Exibindo {{ pagination.items|length }} de <strong>{{ pagination.total }}</strong> resultados encontrados.
            {% if termo %}
                Busca por: <mark>{{ termo }}</mark>
            {% endif %}
        </p>
    </div>

    {% if pagination.items %}
        <table class="application-table results-table">
            <thead>
                <tr>
                    <th>Imagem</th>
                    {# Macro para criar cabeçalhos ordenáveis #}
                    {% macro sortable_header(column_key, display_name) %}
                        {% set next_dir = 'desc' if sort_by == column_key and sort_dir == 'asc' else 'asc' %}
                        <th class="sortable-header {% if sort_by == column_key %}active{% endif %}">
                            <a href="{{ url_for('main.buscar', **(search_args|merge({'sort_by': column_key, 'sort_dir': next_dir}))) }}">
                                {{ display_name }}
                                <span class="sort-arrow">
                                    {% if sort_by == column_key %}
                                        {{ '▲' if sort_dir == 'asc' else '▼' }}
                                    {% else %}
                                        &#x2195; {# Seta dupla para indicar que é ordenável #}
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                    {% endmacro %}

                    {{ sortable_header('codigo', 'Código') }}
                    {{ sortable_header('nome', 'Nome') }}
                    {{ sortable_header('fornecedor', 'Fornecedor') }}
                    <th>Aplicações</th>
                </tr>
            </thead>
            <tbody>
                {% for produto in pagination.items %}
                <tr>
                    <td>
                        <a href="{{ url_for('main.detalhe_peca', id=produto.id) }}">
                            <img src="{% if produto.imagens %}{{ url_for('uploaded_file', filename=produto.imagens[0].filename) }}{% else %}https://via.placeholder.com/60x60/eee/aaa?text=N/A{% endif %}" alt="Imagem de {{ produto.nome }}" class="product-image-thumbnail">
                        </a>
                    </td>
                    <td>{{ produto.codigo|highlight(termo) }}</td>
                    <td>
                        <a href="{{ url_for('main.detalhe_peca', id=produto.id) }}" style="text-decoration: none; color: #0056b3; font-weight: bold;">
                            {{ produto.nome|highlight(termo) }}
                        </a>
                    </td>
                    <td>{{ produto.fornecedor|highlight(termo) }}</td>
                    <td>
                        {% for aplicacao in produto.aplicacoes[:2] %}
                            <span class="badge badge-manual">{{ aplicacao.montadora or '' }} {{ aplicacao.veiculo or '' }} {{ aplicacao.ano or '' }}</span><br>
                        {% endfor %}
                        {% if produto.aplicacoes|length > 2 %}
                            <span style="font-size: 0.8em; color: #666;">... e mais {{ produto.aplicacoes|length - 2 }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {{ render_pagination(pagination, endpoint or 'main.buscar', search_args) }}
    {% else %}
        <p style="text-align: center; padding: 20px;">Nenhum produto encontrado para os critérios de busca.</p>
    {% endif %}
{% endblock %}