{% extends "base.html" %}

{% block title %}Editar Peça{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .similar-search-container { position: relative; }
        .similar-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        .similar-result-item { padding: 8px 12px; cursor: pointer; }
        .similar-result-item:hover { background-color: #f0f0f0; }
        .selected-similar-list { margin-top: 10px; }
        .selected-similar-item { display: flex; justify-content: space-between; align-items: center; background-color: #e9ecef; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; }
        .remove-similar-btn { cursor: pointer; color: #dc3545; font-weight: bold; background: none; border: none; font-size: 1.2em; }
        .validation-message { font-size: 0.9em; margin-top: 5px; }
        .validation-message.success { color: #28a745; }
        .validation-message.error { color: #dc3545; }
    </style>
{% endblock %}

{% block content %}
        {# Passa as URLs necessárias para o JavaScript através de atributos de dados no body. A tag <body> é essencial aqui. #}
        <body data-product-id="{{ produto.id }}" 
              data-get-montadora-url="{{ url_for('get_montadora_for_veiculo') }}"
              data-similar-search-url="{{ url_for('buscar_pecas_similares') }}"
        >

        <header>
            <h1>Editar Peça</h1>
        </header>

        <form action="{{ url_for('editar_peca', id=produto.id) }}" method="POST" enctype="multipart/form-data" class="search-section" novalidate>
            <input type="hidden" id="ordem_imagens" name="ordem_imagens">

            <div class="search-field">
                <label for="nome">Nome da Peça</label>
                <input type="text" id="nome" name="nome" class="form-control" value="{{ produto.nome }}" required>
            </div>
            <div class="search-field">
                <label for="codigo">Código</label>
                <input type="text" id="codigo" name="codigo" class="form-control" value="{{ produto.codigo }}" required>
                <div id="codigo-validation-message" class="validation-message"></div> {# Mantido para validação em tempo real #}
            </div>
            
            <datalist id="montadoras-lista">
                {% for fab_item in montadoras %}
                    <option value="{{ fab_item }}">
                {% endfor %}
            </datalist>

            <div class="search-field">
                <label for="fornecedor">Fornecedor</label>
                <input type="text" id="fornecedor" name="fornecedor" list="fornecedores-lista" autocomplete="off" value="{{ produto.fornecedor or '' }}">
                <datalist id="fornecedores-lista">
                    {% for forn_item in fornecedores %}
                        <option value="{{ forn_item }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="search-field">
            </div>

            <div class="search-field"> 
                <label for="grupo">Grupo</label>
                <input type="text" id="grupo" name="grupo" list="grupos-lista" autocomplete="off" value="{{ produto.grupo or '' }}">
                <datalist id="grupos-lista">
                    {% for grupo_item in grupos %}
                        <option value="{{ grupo_item }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="search-field">
                <label for="medidas">Medidas</label>
                <textarea id="medidas" name="medidas" rows="4" placeholder="Ex: 200mm x 50mm (uma medida por linha)">{{ produto.medidas or '' }}</textarea>
            </div>

            <!-- Seção de Aplicações Dinâmicas -->
            <div id="aplicacoes-container" style="width: 100%;">
                {% for aplicacao in produto.aplicacoes %}
                <div class="aplicacao-bloco" style="margin-top: 20px;" data-index="{{ loop.index0 }}">
                    <h4 style="width: 100%; margin-top: 0;">Aplicação {{ loop.index }}</h4>
                    <input type="hidden" name="aplicacoes-{{ loop.index0 }}-id" value="{{ aplicacao.id }}">
                    <div class="search-field"><label>Veículo:</label><input type="text" name="aplicacoes-{{ loop.index0 }}-veiculo" value="{{ aplicacao.veiculo or '' }}"></div>
                    <div class="search-field"><label>Ano:</label><input type="text" name="aplicacoes-{{ loop.index0 }}-ano" value="{{ aplicacao.ano or '' }}"></div>
                    <div class="search-field"><label>Motor:</label><input type="text" name="aplicacoes-{{ loop.index0 }}-motor" value="{{ aplicacao.motor or '' }}"></div>
                    <div class="search-field"><label>Conf. MTR:</label><input type="text" name="aplicacoes-{{ loop.index0 }}-conf_mtr" value="{{ aplicacao.conf_mtr or '' }}"></div>
                    <div class="search-field"><label>Montadora:</label><input type="text" name="aplicacoes-{{ loop.index0 }}-montadora" list="montadoras-lista" autocomplete="off" value="{{ aplicacao.montadora or '' }}"></div>
                    <div style="width: 100%; text-align: right;">
                        <button type="button" class="remove-aplicacao-btn" data-id="{{ aplicacao.id }}" style="background-color: #dc3545; font-size: 0.9em; padding: 8px 12px;">Remover</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-aplicacao-btn" style="background-color: #17a2b8; margin-top: 19px; margin-bottom: 20px;">Adicionar outra aplicação</button>

            <!-- Novo campo de busca para Códigos Similares -->
            <div class="search-field" style="width: 48%;">
                <label for="similar-search">Buscar Códigos Similares:</label>
                <div class="similar-search-container">
                    <input type="text" id="similar-search" placeholder="Digite código ou nome para buscar..." autocomplete="off">
                    <div id="similar-results" class="similar-results"></div>
                </div>
                <div id="selected-similar-list" class="selected-similar-list">
                    {% for similar in produto.similares|sort(attribute='codigo') %}
                    <div class="selected-similar-item" data-id="{{ similar.id }}"><span>{{ similar.codigo }} - {{ similar.nome }}</span><button type="button" class="remove-similar-btn" title="Remover">×</button></div>
                    {% endfor %}
                </div>
                <input type="hidden" id="similares_ids" name="similares_ids" value="{{ produto.similares|map(attribute='id')|join(',') }}">
            </div>

            <!-- Seção de Similares Dinâmicos -->
            <div class="search-field" style="width: 100%;">
                <label for="conversoes">Nº Conversão</label>
                <textarea id="conversoes" name="conversoes" rows="8">{{ produto.conversoes or '' }}</textarea>
            </div>

            <div class="search-field" style="width: 100%;">
                <label for="observacoes">Observações</label>
                <textarea id="observacoes" name="observacoes" rows="4">{{ produto.observacoes or '' }}</textarea>
            </div>

            <div class="search-field">
                <label>Imagens Atuais:</label>
                {% if produto.imagens %}
                    <div id="image-list-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                    {% for imagem in produto.imagens %}
                        <div class="image-item" data-id="{{ imagem.id }}" style="position: relative; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                            <img src="{{ url_for('uploaded_file', filename=imagem.filename) }}" alt="Imagem do Produto" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;" class="product-image">
                            <div class="drag-handle" title="Arraste para reordenar">☰</div>
                            <button type="button" class="remove-image-btn" data-id="{{ imagem.id }}" title="Remover imagem" style="position: absolute; top: 0; right: 0; background: #dc3545; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-weight: bold; line-height: 22px; padding: 0; font-size: 14px;">X</button>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p>Nenhuma imagem cadastrada.</p>
                {% endif %}
                <label for="imagens">Adicionar Novas Imagens</label>
                <input type="file" id="imagens" name="imagens" multiple accept="image/*">
                <!-- Container para pré-visualização de novas imagens -->
                <div id="new-image-preview-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                </div>
                
                <hr style="margin: 15px 0;">

                <label for="imagem_url">Ou Adicionar Imagem por URL</label>
                <input type="url" id="imagem_url" name="imagem_url" placeholder="https://exemplo.com/imagem.jpg" style="width: 100%; box-sizing: border-box;">

            </div>
            
            <input type="submit" value="Salvar Alterações">
            <a href="{{ url_for('detalhe_peca', id=produto.id) }}" class="button" style="background-color: #555; color: white; padding: 12px 20px; text-decoration: none; border-radius: 4px;">Cancelar</a>
        </form>
{% endblock %}

{% block scripts %}
        {{ super() }}
        <script>
            // Adiciona o listener ao formulário para atualizar dados ocultos antes de enviar
            document.querySelector('form').addEventListener('submit', function() {
                // Atualiza ordem das imagens
                const container = document.getElementById('image-list-container') || document.createElement('div');
                const imageIds = Array.from(container.querySelectorAll('.image-item[data-id]')).map(item => item.dataset.id);
                document.getElementById('ordem_imagens').value = imageIds.join(','); // Mantém a lógica JS para reordenação
                // Atualiza IDs dos similares (já é feito dinamicamente, mas garante)
            });

            document.getElementById('add-aplicacao-btn').addEventListener('click', function() {
                const container = document.getElementById('aplicacoes-container');
                const index = container.getElementsByClassName('aplicacao-bloco').length;
                
                const novoBloco = document.createElement('div');
                novoBloco.classList.add('aplicacao-bloco');
                novoBloco.style.marginTop = '20px';
                novoBloco.dataset.index = index;
                novoBloco.innerHTML = `
                    <h4 style="width: 100%; margin-top: 0;">Nova Aplicação ${index + 1}</h4>
                    <input type="hidden" name="aplicacoes-${index}-id" id="aplicacoes-${index}-id">
                    <div class="search-field"><label for="aplicacoes-${index}-veiculo">Veículo:</label><input type="text" id="aplicacoes-${index}-veiculo" name="aplicacoes-${index}-veiculo"></div>
                    <div class="search-field"><label for="aplicacoes-${index}-ano">Ano:</label><input type="text" id="aplicacoes-${index}-ano" name="aplicacoes-${index}-ano"></div>
                    <div class="search-field"><label for="aplicacoes-${index}-motor">Motor:</label><input type="text" id="aplicacoes-${index}-motor" name="aplicacoes-${index}-motor"></div>
                    <div class="search-field"><label for="aplicacoes-${index}-conf_mtr">Conf. MTR:</label><input type="text" id="aplicacoes-${index}-conf_mtr" name="aplicacoes-${index}-conf_mtr"></div>
                    <div class="search-field"><label for="aplicacoes-${index}-montadora">Montadora:</label><input type="text" id="aplicacoes-${index}-montadora" name="aplicacoes-${index}-montadora" list="montadoras-lista" autocomplete="off"></div>
                    <div style="width: 100%; text-align: right;"><button type="button" class="remove-aplicacao-btn" style="background-color: #dc3545; font-size: 0.9em; padding: 8px 12px;">Remover</button></div>
                `;
                
                container.appendChild(novoBloco);
            });

            // Adiciona o listener para os botões de remover aplicação
            document.getElementById('aplicacoes-container').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-aplicacao-btn')) {
                    const button = e.target;
                    const aplicacaoId = button.dataset.id;
                    const aplicacaoBloco = button.closest('.aplicacao-bloco');

                    if (!aplicacaoId) {
                        // Se não tem ID, é um bloco novo, apenas remove da tela
                        aplicacaoBloco.remove();
                        return;
                    }

                    if (confirm('Tem certeza que deseja remover esta aplicação permanentemente?')) {
                        fetch(`/aplicacao/${aplicacaoId}/excluir_ajax`, {
                            method: 'DELETE',
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                aplicacaoBloco.remove(); // Remove o bloco da tela
                            } else {
                                alert('Erro ao remover aplicação: ' + data.message);
                            }
                        })
                        .catch(error => console.error('Erro:', error));
                    }
                }
            });

            // --- Lógica para autocompletar montadora ---
            function handleVeiculoBlur(event) {
                const veiculoInput = event.target;
                // Garante que o evento só seja acionado para inputs de veículo
                if (!veiculoInput.name.endsWith('-veiculo')) return;

                const veiculoNome = veiculoInput.value.trim();
                if (veiculoNome.length < 3) return;

                const aplicacaoBloco = veiculoInput.closest('.aplicacao-bloco');
                const montadoraInput = aplicacaoBloco.querySelector('input[name$="-montadora"]');

                // Só preenche se o campo montadora estiver vazio
                if (montadoraInput && !montadoraInput.value) {
                    fetch(`{{ url_for('get_montadora_for_veiculo') }}?veiculo=${encodeURIComponent(veiculoNome)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.montadora) {
                                montadoraInput.value = data.montadora;
                            }
                        });
                }
            }
            document.getElementById('aplicacoes-container').addEventListener('blur', handleVeiculoBlur, true);

            // --- Validação de Código em Tempo Real (Edição) ---
            const codigoInput = document.getElementById('codigo');
            const validationMessage = document.getElementById('codigo-validation-message');
            const produtoId = {{ produto.id|tojson }};
            let debounceTimer;

            codigoInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const codigo = this.value.trim();

                if (codigo.length < 3) {
                    validationMessage.textContent = '';
                    validationMessage.className = 'validation-message';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`{{ url_for('check_codigo') }}?codigo=${encodeURIComponent(codigo)}&produto_id=${produtoId || ''}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                validationMessage.textContent = `Atenção: Código já em uso pelo produto "${data.nome}".`;
                                validationMessage.className = 'validation-message error';
                            } else {
                                validationMessage.textContent = 'Código disponível!';
                                validationMessage.className = 'validation-message success';
                            }
                        })
                        .catch(error => {
                            console.error('Erro na validação do código:', error);
                            validationMessage.textContent = 'Erro ao validar o código.';
                            validationMessage.className = 'validation-message error';
                        });
                }, 500); // Aguarda 500ms após o usuário parar de digitar
            });
        </script>
        <script src="{{ url_for('static', filename='js/form_helpers.js') }}"></script>

        <!-- Inclui o SortableJS -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
        <script>
            const el = document.getElementById('image-list-container');
            if (el) {
                const sortable = Sortable.create(el, {
                    animation: 150, // Animação ao mover
                    handle: '.drag-handle' // Define a área de arrastar
                });
            }

            // --- Lógica para remover imagem existente ---
            const imageListContainer = document.getElementById('image-list-container');
            if (imageListContainer) {
                imageListContainer.addEventListener('click', function(e) {
                    if (e.target && e.target.classList.contains('remove-image-btn')) {
                        const button = e.target;
                        const imageId = button.dataset.id;
                        const imageItem = button.closest('.image-item');

                        if (confirm('Tem certeza que deseja remover esta imagem permanentemente?')) {
                            fetch(`/imagem/${imageId}/excluir`, {
                                method: 'DELETE',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' } // Cabeçalho comum para AJAX
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    imageItem.remove(); // Remove o item da imagem da tela
                                } else {
                                    alert('Erro ao remover imagem: ' + data.message);
                                }
                            })
                            .catch(error => console.error('Erro:', error));
                        }
                    }
                });
            }
        </script>
{% endblock %}