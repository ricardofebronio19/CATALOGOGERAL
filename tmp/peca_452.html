<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUBO DE RODA TRASEIRO COM ROLAMENTO GRAND SIENA 1.4 8V (2017 &gt; 2021) / 1.6 16V (2017 &gt; 2018) | IDEA 1.4 8V (2005 &gt; 2016) / 1.6 16V (2005 &gt; 2016) / 1.8 16V (2005 &gt; 2012) / 1.8 8V (2005 &gt; 2010) | IDEA ADVENTURE 1.8 8V (2006 &gt; 2010) | PALIO 1.0 8V (2006 &gt; 2017) / 1.4 8V (2005 &gt; 2015) / 1.6 8V (1997 &gt; 2001) / 1.8 8V (2004 &gt; 2010) | PREMIO 1.3 8V (1985 &gt; 1992) / 1.5 8V (1985 &gt; 1994) / 1.6 8V (1989 &gt; 1994) | SIENA 1.0 16V (2000 &gt; 2003) / 1.0 8V (2010 &gt; 2016) / 1.3 16V (2000 &gt; 2003) / 1.4 8V (2005 &gt; 2016) / 1.5 8V (2002 &gt; 2004) / 1.6 16V (1997 &gt; 2018) / 1.8 8V (2003 &gt; 2010) | STILO 1.8 16V (2002 &gt; 2004) / 1.8 8V (2005 &gt; 2010) / 2.4 20V (2002 &gt; 2008) | TIPO 1.6 8V (1993 &gt; 1997) | UNO 1.0 8V (2009 &gt; 2013) / 1.3 8V (2007 &gt; 2013) | UNO WAY 1.0 6V (2016 &gt; 2021) / 1.0 8V (2009 &gt; 2016) / 1.3 8V (2016 &gt; 2021) / 1.4 8V (2010 &gt; 2016) FURO DO ROLAMENTO 30 MM QTD DE FUROS 4 FURAÇÃO 4 X 98 MM - Detalhes</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --cor-principal: #ff6600;
        }
        /* Estilos para o menu dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 5px;
            overflow: hidden; /* Garante que os cantos arredondados se apliquem aos itens */
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            background-color: #f9f9f9; /* Garante que o fundo não seja transparente */
            border: none; /* Remove bordas do estilo .button */
            width: 100%;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
    
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <nav class="top-nav">
        <div class="nav-content-wrapper">
            <div class="nav-left">
                <a href="/" class="logo-link">
                    
                        <span class="logo-text">Catálogo</span>
                    
                </a>
            </div>

            <div class="nav-center-group">
                
                    <div class="nav-center">
                        <form action="/buscar" method="GET" class="search-form">
                            <input type="search" name="termo" placeholder="Buscar por código, nome, aplicação..." value="">
                            <button type="submit" class="button">Buscar</button>
                        </form>
                    </div>
                
    
                <div class="nav-right">
                    <a href="/" class="button">Nova Busca</a>
                    
                    
                        <a href="/login" class="button">Login</a>
                    
                </div>
            </div>
        </div>
    </nav>

    <div class="flash-messages">
        
            
        
        
        <!-- Banner de Atualização Melhorado -->
        
    </div>

    <main class="container">
        
        <header>
            <h1>Detalhes do Produto</h1>
        </header>

        <div class="product-detail-header">
            <div class="product-detail-info">
                <h2>CUBO DE RODA TRASEIRO COM ROLAMENTO GRAND SIENA 1.4 8V (2017 &gt; 2021) / 1.6 16V (2017 &gt; 2018) | IDEA 1.4 8V (2005 &gt; 2016) / 1.6 16V (2005 &gt; 2016) / 1.8 16V (2005 &gt; 2012) / 1.8 8V (2005 &gt; 2010) | IDEA ADVENTURE 1.8 8V (2006 &gt; 2010) | PALIO 1.0 8V (2006 &gt; 2017) / 1.4 8V (2005 &gt; 2015) / 1.6 8V (1997 &gt; 2001) / 1.8 8V (2004 &gt; 2010) | PREMIO 1.3 8V (1985 &gt; 1992) / 1.5 8V (1985 &gt; 1994) / 1.6 8V (1989 &gt; 1994) | SIENA 1.0 16V (2000 &gt; 2003) / 1.0 8V (2010 &gt; 2016) / 1.3 16V (2000 &gt; 2003) / 1.4 8V (2005 &gt; 2016) / 1.5 8V (2002 &gt; 2004) / 1.6 16V (1997 &gt; 2018) / 1.8 8V (2003 &gt; 2010) | STILO 1.8 16V (2002 &gt; 2004) / 1.8 8V (2005 &gt; 2010) / 2.4 20V (2002 &gt; 2008) | TIPO 1.6 8V (1993 &gt; 1997) | UNO 1.0 8V (2009 &gt; 2013) / 1.3 8V (2007 &gt; 2013) | UNO WAY 1.0 6V (2016 &gt; 2021) / 1.0 8V (2009 &gt; 2016) / 1.3 8V (2016 &gt; 2021) / 1.4 8V (2010 &gt; 2016) FURO DO ROLAMENTO 30 MM QTD DE FUROS 4 FURAÇÃO 4 X 98 MM</h2>
                <p>
                    <strong>Código:</strong> 
                    <span id="product-code">AL-670</span>
                    <button onclick="copyToClipboard('AL-670', 'Código do produto')" title="Copiar código" style="background: none; border: none; cursor: pointer; padding: 0 5px;">
                        <img src="/static/copy-icon.svg" alt="Copiar" style="width: 16px; height: 16px; vertical-align: middle;">
                    </button>
                </p>
                <p><strong>Grupo:</strong> ROLAMENTOS E CUBOS</p>
                <p><strong>Fornecedor:</strong> IMA</p>
                
                
            </div>
            <!-- Galeria de Imagens -->
            <div class="image-gallery">
                <div class="main-image-container">
                    <img id="mainProductImage" src="https://via.placeholder.com/250x250/eee/aaa?text=Sem+Imagem" alt="Imagem do Produto" class="product-detail-image" title="Clique para ampliar">
                </div>
                
            </div>
        </div>

        <div class="details-layout-container">
            <!-- Seção de Conversões (Esquerda) -->
            
            <div class="info-section-lateral">
                <h3>Conversões</h3>
                <pre id="conversoes-content">COFAP CRC03027 FREMAX FWB0554 HIPPER HFCT37A IRB IR18670 | NAKATA NKF8060 | ORIGINAL 51827178, 7787124, 97659391 | PERFECT CDRT0106 TAS C11F178 VETOR B9391 VOBER 31040425 31040428 CATÁLOGO DE PRODUTOS E APLICAÇÕES FOTO / CÓDIGO / APLICAÇÃO INFORMAÇÕES ADICIONAIS Nº CONVERSÃO</pre>
            </div>
            

            <!-- Seção de Aplicações (Centro) -->
            <div class="application-section">
                <h3 style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <span>Aplicações</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        
                        <button id="clear-filter-btn" class="button" style="display: none; background-color: #6c757d; font-size: 0.8em; padding: 5px 10px;">Limpar Filtro</button>
                    </div>
                </h3>
                <div class="filter-help-text">
                    <img src="/static/info-icon.svg" alt="Info">
                    <span>Clique em uma aplicação para filtrar os produtos similares.</span>
                </div>
                <div id="applicationSearchCount" style="margin-bottom: 10px; font-size: 11px; color: #6c757d; font-style: italic; text-align: right;">
                    <!-- Contador será preenchido via JavaScript -->
                </div>

                
                    <p style="padding: 15px; text-align: center;">Nenhuma aplicação cadastrada para este produto.</p>
                
            </div>

            <!-- Seção de Medidas (Direita) -->
            
        </div>

        <!-- Seção de Observações -->
        
        <div class="info-section similar-section">
            <h3>Observações</h3>
            <pre>POSIÇÃO TRASEIRO | LADO DIREITO/ESQUERDO ALBARUS ALB70-265</pre>
        </div>
        

        <!-- Seção de Produtos Similares -->
        

        <!-- Seção de Produtos Similares (MANUAL) -->

        <!-- O Modal/Popup da Imagem -->
        <div id="imageModal" class="image-modal">
            <span class="modal-close">&times;</span>
            <img class="modal-content" id="modalImage">
        </div>

        <style>
            .badge {
                padding: 3px 8px;
                border-radius: 10px;
                font-size: 0.8em;
                font-weight: bold;
                color: white;
            }
            .badge-manual { background-color: #6c757d; } /* Cinza */
            .badge-auto { background-color: #17a2b8; } /* Ciano */

            .application-row.active-filter {
                background-color: #fff3cd !important; /* Amarelo claro para destacar */
                font-weight: bold;
            }
            .no-results-row td {
                text-align: center;
                padding: 20px;
                color: #666;
                font-style: italic;
            }
            .filter-help-text {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 15px;
                background-color: #f8f9fa;
                font-size: 0.9em;
                color: #555;
            }
            .filter-help-text img { width: 16px; height: 16px; }
            .similar-applications {
                font-size: 0.9em;
                max-height: 80px;
                overflow-y: auto;
                padding-right: 5px;
            }
            .similar-applications div {
                display: flex;
                justify-content: space-between;
                gap: 10px;
                white-space: nowrap;
            }
            .similar-applications small {
                color: #555;
                font-style: italic;
            }
            .more-apps { font-style: italic; color: #888; font-size: 0.9em; }

            /* Lista vertical compacta para Veículo / Ano / Motor nas colunas de similares */
            .vertical-list { display: flex; flex-direction: column; gap: 2px; position: relative; }
            .vertical-list div { line-height: 1.25; font-size: 0.95em; }

            /* Tooltip customizado (multi-line) usando data-tooltip */
            .vertical-list[data-tooltip]::after {
                content: attr(data-tooltip);
                white-space: pre-line; /* preserva quebras de linha */
                position: absolute;
                left: 0;
                top: calc(100% + 8px);
                z-index: 3000;
                display: none;
                background: rgba(30,30,30,0.95);
                color: #fff;
                padding: 8px 10px;
                border-radius: 6px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.35);
                font-size: 0.9em;
                line-height: 1.2em;
                max-width: 360px;
                word-wrap: break-word;
            }
            .vertical-list[data-tooltip]:hover::after { display: block; }

        </style>

        <style>
            /* Estilos do modal de imagem (centralizado fullscreen) */
            .image-modal {
                position: fixed;
                inset: 0;
                display: none;
                justify-content: center;
                align-items: center;
                background: rgba(0,0,0,0.75);
                z-index: 2000;
            }
            .image-modal .modal-close {
                position: absolute;
                top: 18px;
                right: 18px;
                font-size: 28px;
                color: white;
                cursor: pointer;
                background: rgba(0,0,0,0.3);
                padding: 6px 10px;
                border-radius: 6px;
            }
            .image-modal .modal-content {
                max-width: 90%;
                max-height: 90%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.5);
                border-radius: 4px;
                transition: transform 0.15s ease-out;
                cursor: zoom-in;
            }
        </style>


    </main>

    <footer class="site-footer">
        <p class="footer-center">Catálogo de Peças vv1.8.0 - Desenvolvido com Flask.</p>
    </footer>

    
    
    <script>
        // Script para fechar as mensagens flash
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message) {
                message.addEventListener('click', function() {
                    this.style.opacity = '0';
                    setTimeout(() => this.remove(), 300);
                });
            });

            // Lógica para fechar dropdowns ao clicar fora
            window.addEventListener('click', function(e) {
                document.querySelectorAll('.dropdown').forEach(function(dropdown) {
                    if (!dropdown.contains(e.target)) {
                        // Esconde o conteúdo se o clique foi fora do dropdown
                        let content = dropdown.querySelector('.dropdown-content');
                        if (content) {
                           // A lógica de hover já controla isso, mas pode ser útil para mobile
                           // content.style.display = 'none';
                        }
                    }
                });
            });
        });
    </script>
    
    
    <script>
        // Função para trocar a imagem principal na galeria
        function changeMainImage(newSrc) {
            const mainImage = document.getElementById('mainProductImage');
            if (mainImage) mainImage.src = newSrc;
        }

        function copyToClipboard(text, type = 'Texto') {
            navigator.clipboard.writeText(text).then(function() {
                // Cria uma notificação temporária
                const notification = document.createElement('div');
                notification.innerText = `${type} copiado: ${text}`;
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = '#28a745';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '5px';
                document.body.appendChild(notification);
                setTimeout(() => { document.body.removeChild(notification); }, 2000);
            }, function(err) {
                console.error('Erro ao copiar texto: ', err);
            });
        }

        // Função para busca em aplicações
        function setupApplicationSearch() {
            const searchInput = document.getElementById('applicationSearchInput');
            const applicationTableBody = document.getElementById('application-table-body');
            const searchCountDiv = document.getElementById('applicationSearchCount');
            
            if (!searchInput || !applicationTableBody) return;

            // Armazenar todas as linhas originais
            const allRows = Array.from(applicationTableBody.querySelectorAll('tr'));
            const applicationRows = allRows.filter(row => row.classList.contains('application-row'));
            const fabricanteHeaders = allRows.filter(row => row.classList.contains('fabricante-header'));
            
            // Função para atualizar contador
            function updateCounter(visibleCount, totalCount) {
                if (searchCountDiv) {
                    if (visibleCount === totalCount) {
                        searchCountDiv.textContent = `${totalCount} aplicações`;
                    } else {
                        searchCountDiv.textContent = `${visibleCount} de ${totalCount} aplicações`;
                        searchCountDiv.style.cursor = 'pointer';
                        searchCountDiv.title = 'Clique para limpar filtro';
                    }
                }
            }
            
            // Função para limpar busca
            function clearSearch() {
                searchInput.value = '';
                filterApplications();
                searchCountDiv.style.cursor = 'default';
                searchCountDiv.title = '';
            }
            
            // Inicializar contador
            updateCounter(applicationRows.length, applicationRows.length);

            // Função de filtro
            function filterApplications() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    // Mostrar todas as linhas
                    allRows.forEach(row => row.style.display = '');
                    updateCounter(applicationRows.length, applicationRows.length);
                    return;
                }

                let visibleCount = 0;
                const visibleFabricantes = new Set();

                // Filtrar aplicações
                applicationRows.forEach(row => {
                    const veiculo = (row.getAttribute('data-veiculo') || '').toLowerCase();
                    const ano = (row.getAttribute('data-ano') || '').toLowerCase();
                    const motor = (row.getAttribute('data-motor') || '').toLowerCase();
                    const cells = Array.from(row.cells);
                    const configuracao = cells.length > 3 ? (cells[3].textContent || '').toLowerCase() : '';

                    const matches = veiculo.includes(searchTerm) || 
                                   ano.includes(searchTerm) || 
                                   motor.includes(searchTerm) || 
                                   configuracao.includes(searchTerm);

                    if (matches) {
                        row.style.display = '';
                        visibleCount++;
                        // Identificar fabricante desta aplicação
                        const fabricanteRow = row.previousElementSibling;
                        if (fabricanteRow && fabricanteRow.classList.contains('fabricante-header')) {
                            visibleFabricantes.add(fabricanteRow);
                        } else {
                            // Procurar para trás até encontrar o cabeçalho do fabricante
                            let current = row.previousElementSibling;
                            while (current) {
                                if (current.classList.contains('fabricante-header')) {
                                    visibleFabricantes.add(current);
                                    break;
                                }
                                current = current.previousElementSibling;
                            }
                        }
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Mostrar/ocultar cabeçalhos de fabricante
                fabricanteHeaders.forEach(header => {
                    if (visibleFabricantes.has(header)) {
                        header.style.display = '';
                    } else {
                        header.style.display = 'none';
                    }
                });

                updateCounter(visibleCount, applicationRows.length);
            }

            // Event listener para busca em tempo real
            searchInput.addEventListener('input', filterApplications);
            
            // Event listener para Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterApplications();
                }
            });
            
            // Event listener para limpar busca clicando no contador
            if (searchCountDiv) {
                searchCountDiv.addEventListener('click', function() {
                    if (searchInput.value.trim()) {
                        clearSearch();
                    }
                });
            }
        }

        // --- Lógica Principal da Página ---
        document.addEventListener('DOMContentLoaded', function() {

            /**
             * Configura a funcionalidade do modal de imagem (zoom).
             */
            function setupImageModal() {
                const modal = document.getElementById("imageModal");
                const mainImg = document.getElementById("mainProductImage");
                const modalImg = document.getElementById("modalImage");
                const closeSpan = document.getElementsByClassName("modal-close")[0];

                if (!modal || !mainImg || !modalImg || !closeSpan) return;

                const openModal = () => {
                    modal.style.display = "flex";
                    modalImg.src = mainImg.src;
                };

                const closeModal = () => {
                    modal.style.display = "none";
                };

                mainImg.addEventListener('click', openModal);
                closeSpan.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(); // Fecha se clicar fora da imagem
                });

                // Zoom ao passar o mouse: ao entrar aplicamos escala, ao mover ajustamos transform-origin
                // para simular pan conforme o cursor. Ao sair, retornamos ao estado normal.
                let zoomScale = 2.0;
                let isZoomed = false;

                modalImg.style.transition = 'transform 0.15s ease-out';

                modalImg.addEventListener('mouseenter', (e) => {
                    // Só ativa zoom se o modal estiver visível
                    if (modal.style.display !== 'flex') return;
                    isZoomed = true;
                    modalImg.style.transform = `scale(${zoomScale})`;
                    modalImg.style.cursor = 'zoom-out';
                });

                modalImg.addEventListener('mouseleave', (e) => {
                    isZoomed = false;
                    modalImg.style.transform = 'scale(1)';
                    modalImg.style.transformOrigin = 'center center';
                    modalImg.style.cursor = 'zoom-in';
                });

                modalImg.addEventListener('mousemove', (e) => {
                    if (!isZoomed) return;
                    const rect = modalImg.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    modalImg.style.transformOrigin = `${x}% ${y}%`;
                });

                // Listener de 'keydown' para fechar o modal com a tecla 'Escape'
                document.addEventListener('keydown', (event) => {
                    if (event.key === "Escape" && modal.style.display === "flex") {
                        event.stopImmediatePropagation(); // Impede que outros listeners de 'Escape' sejam acionados
                        closeModal();
                    }
                });
            }

            /**
             * Transforma a seção de conversões em elementos clicáveis.
             */
            function setupInteractiveConversions() {
                const container = document.getElementById('conversoes-content');
                if (!container) return;

                const rawText = container.innerText;
                const lines = rawText.split('\n').filter(line => line.trim() !== '');

                const newHtml = lines.map(line => {
                    const trimmedLine = line.trim();
                    // Heurística: uma linha é marca se for maiúscula e não contiver números.
                    const isLikelyBrand = /^[A-Z\s]+$/.test(trimmedLine) && !/\d/.test(trimmedLine);

                    if (isLikelyBrand) {
                        return `<span class="conversion-brand">${trimmedLine}</span>`;
                    } else {
                        // Adiciona a funcionalidade de clique para copiar
                        return `<span class="conversion-code" title="Clique para copiar: ${trimmedLine}" onclick="copyToClipboard('${trimmedLine}', 'Código de conversão')">${trimmedLine}</span>`;
                    }
                }).join('\n');

                container.innerHTML = newHtml;
            }

            /**
             * Configura a lógica de filtragem de produtos similares ao clicar em uma aplicação.
             */
            function setupSimilarFiltering() {
                const tableBody = document.getElementById('application-table-body');
                const similarRows = document.querySelectorAll('.similar-row');
                const noResultsRow = document.getElementById('no-similar-results-row');
                const clearFilterBtn = document.getElementById('clear-filter-btn');

                if (!tableBody || !clearFilterBtn || similarRows.length === 0) return;
            
            /**
             * Converte uma string de ano (ex: "2010", "2010/2015", "2018/...") 
             * em um objeto com ano inicial e final.
             * @param {string} yearStr A string do ano.
             * @returns {{start: number, end: number}}
             */
            function parseYearRange(yearStr) {
                if (!yearStr || !yearStr.trim()) {
                    const result = { start: -Infinity, end: Infinity };
                    console.log(`parseYearRange('${yearStr}') = vazio →`, result);
                    return result; // Corresponde a qualquer ano se vazio
                }
                yearStr = yearStr.trim();
                console.log(`parseYearRange('${yearStr}') processando...`);

                // Formato: 2018/... ou 2018/
                if (yearStr.endsWith('/...') || yearStr.endsWith('/')) {
                    const startYear = parseInt(yearStr, 10); // Especifica o radix 10
                    const result = { start: startYear, end: Infinity };
                    console.log(`parseYearRange('${yearStr}') = início aberto →`, result);
                    return result;
                }
                // Formato: .../2015 ou /2015
                if (yearStr.startsWith('.../') || yearStr.startsWith('/')) {
                    const endYear = parseInt(yearStr.substring(yearStr.indexOf('/') + 1), 10);
                    const result = { start: -Infinity, end: endYear };
                    console.log(`parseYearRange('${yearStr}') = fim aberto →`, result);
                    return result;
                }
                // Formato: 2010/2015
                if (yearStr.includes('/')) {
                    const parts = yearStr.split('/');
                    const start = parseInt(parts[0], 10);
                    const end = parseInt(parts[1], 10);
                    const result = { start: Math.min(start, end), end: Math.max(start, end) };
                    console.log(`parseYearRange('${yearStr}') = intervalo →`, result);
                    return result;
                }
                // Formato: 2010
                const singleYear = parseInt(yearStr, 10);
                if (!isNaN(singleYear)) {
                    const result = { start: singleYear, end: singleYear };
                    console.log(`parseYearRange('${yearStr}') = ano único →`, result);
                    return result;
                }

                const fallback = { start: -Infinity, end: Infinity };
                console.log(`parseYearRange('${yearStr}') = fallback →`, fallback);
                return fallback; // Fallback
            }

            /**
             * Verifica se dois intervalos de anos se sobrepõem.
             * @param {{start: number, end: number}} range1
             * @param {{start: number, end: number}} range2
             * @returns {boolean}
             */
            function rangesOverlap(range1, range2) {
                // A sobreposição existe se o início de um intervalo for menor ou igual ao fim do outro, e vice-versa.
                const overlap = range1.start <= range2.end && range2.start <= range1.end;
                console.log(`rangesOverlap(`, range1, `,`, range2, `) = ${overlap}`);
                return overlap;
            }

            function filterSimilars(clickedRow) {
                // Captura todos os dados da aplicação clicada
                const filtro = {
                    veiculo: clickedRow.dataset.veiculo.trim().toLowerCase(),
                    anoRange: parseYearRange(clickedRow.dataset.ano),
                    motor: clickedRow.dataset.motor.trim().toLowerCase()
                };
                let visibleCount = 0;
                
                console.log('Filtro aplicado:', filtro);
                console.log('Processando', similarRows.length, 'produtos similares');

                // Limpa o filtro ativo anterior
                tableBody.querySelectorAll('.application-row.active-filter').forEach(row => row.classList.remove('active-filter'));
                clickedRow.classList.add('active-filter');

                similarRows.forEach((row, index) => {
                    const applications = JSON.parse(row.dataset.applications || '[]');
                    
                    console.log(`Similar ${index + 1}:`, applications);
                    
                    // Verifica se alguma aplicação do produto similar corresponde aos critérios do filtro.
                    // A verificação do ano agora usa a sobreposição de intervalos.
                    const hasMatch = applications.some(app => {
                        const appAnoRange = parseYearRange(app.ano);
                        
                        // O motor é opcional: se o filtro ou a aplicação não tiverem motor, ignora a verificação do motor.
                        const motorMatch = !filtro.motor || !app.motor || app.motor.toLowerCase() === filtro.motor;

                        const veiculoMatch = app.veiculo.toLowerCase() === filtro.veiculo;
                        const anoMatch = rangesOverlap(appAnoRange, filtro.anoRange);
                        
                        console.log(`  App: ${app.veiculo} | Veiculo: ${veiculoMatch} | Ano: ${anoMatch} | Motor: ${motorMatch}`);
                        
                        return veiculoMatch && anoMatch && motorMatch;
                    });

                    if (hasMatch) {
                        row.style.display = '';
                        visibleCount++;
                        console.log(`  → Similar ${index + 1} MOSTRADO`);
                    } else {
                        row.style.display = 'none';
                        console.log(`  → Similar ${index + 1} OCULTO`);
                    }
                });

                noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
                clearFilterBtn.style.display = 'inline-block';
            }

            function clearFilter() {
                tableBody.querySelectorAll('.application-row.active-filter').forEach(row => row.classList.remove('active-filter'));
                similarRows.forEach(row => row.style.display = '');
                noResultsRow.style.display = 'none';
                clearFilterBtn.style.display = 'none';
            }

            // Event Delegation: Adiciona um único listener ao corpo da tabela
            tableBody.addEventListener('click', (event) => {
                const clickedRow = event.target.closest('.application-row');
                if (clickedRow) {
                    console.log('Aplicação clicada:', {
                        veiculo: clickedRow.dataset.veiculo,
                        ano: clickedRow.dataset.ano,
                        motor: clickedRow.dataset.motor
                    });
                    console.log('Similar rows encontradas:', similarRows.length);
                    filterSimilars(clickedRow);
                }
            });

            clearFilterBtn.addEventListener('click', clearFilter);
            
            // Permite clicar em links de veículo (por exemplo na lista lateral) para filtrar similares
            const veiculoLinks = document.querySelectorAll('.veiculo-link');
            veiculoLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const vehicleName = (link.textContent || link.innerText || '').trim();
                    if (!vehicleName) return;
                    // Marca/desmarca linhas na tabela de aplicações para mostrar a seleção
                    tableBody.querySelectorAll('.application-row').forEach(row => {
                        if ((row.dataset.veiculo || '').trim().toLowerCase() === vehicleName.toLowerCase()) {
                            row.classList.add('active-filter');
                        } else {
                            row.classList.remove('active-filter');
                        }
                    });

                    // Filtra os similares para exibir somente os que possuem essa aplicação
                    let visibleCount = 0;
                    similarRows.forEach(row => {
                        const applications = JSON.parse(row.dataset.applications || '[]');
                        const hasMatch = applications.some(app => (app.veiculo || '').trim().toLowerCase() === vehicleName.toLowerCase());
                        if (hasMatch) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    });

                    noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
                    clearFilterBtn.style.display = 'inline-block';
                });
            });
            }

            // Inicializa todos os módulos da página
            setupImageModal();
            setupInteractiveConversions();
            setupSimilarFiltering();
            setupApplicationSearch();

            // --- Remoção de similar via AJAX ---
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.remove-similar-action');
                if (!btn) return;
                e.preventDefault();

                // Encontra o form pai que carrega a URL
                const form = btn.closest('.remove-similar-form');
                if (!form) return;

                if (!confirm('Confirma remoção deste produto similar? Esta ação é irreversível.')) return;

                // Se for uma sugestão, persistimos a ignorância no servidor via POST
                if (form.dataset.suggestion === '1') {
                    const url = form.dataset.url;
                    if (!url) {
                        // fallback: remove apenas frontend
                        const row = form.closest('tr');
                        if (row) row.remove();
                        return;
                    }

                    // Guarda a linha para possível desfazer
                    const row = form.closest('tr');
                    const rowHTML = row ? row.outerHTML : null;
                    const nextSibling = row ? row.nextElementSibling : null;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    }).then(resp => {
                        if (!resp.ok) throw resp;
                        return resp.json();
                    }).then(data => {
                        // Remove a linha da UI
                        if (row) row.remove();

                        const remaining = document.querySelectorAll('.similar-row');
                        const noResultsRow = document.getElementById('no-similar-results-row');
                        if (remaining.length === 0 && noResultsRow) {
                            noResultsRow.style.display = '';
                        }

                        // Cria notificação com botão Desfazer
                        const note = document.createElement('div');
                        note.style.position = 'fixed';
                        note.style.bottom = '20px';
                        note.style.left = '50%';
                        note.style.transform = 'translateX(-50%)';
                        note.style.backgroundColor = '#28a745';
                        note.style.color = 'white';
                        note.style.padding = '10px 20px';
                        note.style.borderRadius = '5px';
                        note.style.display = 'flex';
                        note.style.gap = '10px';

                        const msg = document.createElement('span');
                        msg.innerText = data && data.message ? data.message : 'Sugestão ignorada.';
                        note.appendChild(msg);

                        const undoBtn = document.createElement('button');
                        undoBtn.innerText = 'Desfazer';
                        undoBtn.style.background = 'transparent';
                        undoBtn.style.color = 'white';
                        undoBtn.style.border = '1px solid rgba(255,255,255,0.4)';
                        undoBtn.style.padding = '4px 8px';
                        undoBtn.style.cursor = 'pointer';
                        note.appendChild(undoBtn);

                        document.body.appendChild(note);

                        // Tempo para desfazer (6s)
                        const undoTimeout = setTimeout(() => {
                            if (note.parentNode) note.parentNode.removeChild(note);
                        }, 6000);

                        undoBtn.addEventListener('click', function() {
                            clearTimeout(undoTimeout);
                            // chama DELETE para desfazer a ignorância
                            fetch(url, { method: 'DELETE', credentials: 'same-origin' })
                                .then(r => {
                                    if (!r.ok) throw r;
                                    return r.json();
                                })
                                .then(d => {
                                    // Reinsere a linha no mesmo lugar
                                    const tableBody = document.querySelector('.application-table tbody');
                                    if (rowHTML && tableBody) {
                                        if (nextSibling && nextSibling.parentNode === tableBody) {
                                            nextSibling.insertAdjacentHTML('beforebegin', rowHTML);
                                        } else {
                                            tableBody.insertAdjacentHTML('beforeend', rowHTML);
                                        }
                                    }
                                    if (note.parentNode) note.parentNode.removeChild(note);
                                }).catch(() => {
                                    alert('Não foi possível desfazer a remoção.');
                                });
                        });

                    }).catch(async err => {
                        let msg = 'Erro ao ignorar sugestão.';
                        try {
                            const j = await err.json();
                            if (j && j.message) msg = j.message;
                        } catch (e) {}
                        alert(msg);
                    });

                    return;
                }

                const url = form.dataset.url;
                // Chama endpoint DELETE
                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                }).then(resp => {
                    if (!resp.ok) throw resp;
                    return resp.json();
                }).then(data => {
                    // Remove a linha correspondente
                    const row = form.closest('tr');
                    if (row) row.remove();

                    // Se não houver mais similares visíveis, exibe a linha de 'nenhum resultado'
                    const remaining = document.querySelectorAll('.similar-row');
                    const noResultsRow = document.getElementById('no-similar-results-row');
                    if (remaining.length === 0 && noResultsRow) {
                        noResultsRow.style.display = '';
                    }

                    // Notificação temporária
                    const note = document.createElement('div');
                    note.innerText = data && data.message ? data.message : 'Similar removido.';
                    note.style.position = 'fixed';
                    note.style.bottom = '20px';
                    note.style.left = '50%';
                    note.style.transform = 'translateX(-50%)';
                    note.style.backgroundColor = '#28a745';
                    note.style.color = 'white';
                    note.style.padding = '10px 20px';
                    note.style.borderRadius = '5px';
                    document.body.appendChild(note);
                    setTimeout(() => { document.body.removeChild(note); }, 2500);
                }).catch(async err => {
                    let msg = 'Erro ao remover similar.';
                    try {
                        const j = await err.json();
                        if (j && j.message) msg = j.message;
                    } catch (e) {
                        // fallback
                    }
                    alert(msg);
                });
            });
        });
    </script>
    

</body>
</html>