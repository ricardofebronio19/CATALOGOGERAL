{% extends "base.html" %}

{% block title %}Configura√ß√µes{% endblock %}

{% block content %}
<header>
    <h1>Configura√ß√µes do Sistema</h1>
</header>

<div class="config-container">
    <!-- Se√ß√£o de Apar√™ncia -->
    <div class="config-section">
        <h2>Apar√™ncia</h2>
        <form action="{{ url_for('admin.configuracoes') }}" method="POST" enctype="multipart/form-data" class="search-section" style="max-width: 600px;">
            <div class="search-field">
                <label for="cor_principal">Cor Principal:</label>
                <input type="color" id="cor_principal" name="cor_principal" value="{{ config.cor_principal }}">
            </div>
            <div class="search-field">
                <label for="logo">Logo do Cat√°logo (substituir):</label>
                <input type="file" id="logo" name="logo" accept="image/*">
                {% if config.logo_path %}
                <p style="margin-top: 10px;">Logo atual: <img src="{{ url_for('uploaded_file', filename=config.logo_path) }}" alt="Logo Atual" style="max-height: 40px; vertical-align: middle; background: #f0f0f0; padding: 5px;"></p>
                {% endif %}
            </div>
            <button type="submit" class="button">Salvar Apar√™ncia</button>
        </form>
    </div>

    <!-- Se√ß√£o de Importa√ß√£o -->
    <div class="config-section">
        <h2>Importar Dados</h2>
    <form action="{{ url_for('admin.tarefa_importar_csv') }}" method="POST" enctype="multipart/form-data">
            <div class="search-field">
                <label for="csv_file">Importar Produtos de CSV:</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <button type="submit" class="button">Importar CSV</button>
        </form>
    </div>

    <!-- Se√ß√£o de √çcones das Montadoras (compacta com dropdown) -->
    <div class="config-section">
        <h2>√çcones das Montadoras</h2>
        <form id="montadora-icon-form" action="{{ url_for('admin.configuracoes') }}" method="POST" enctype="multipart/form-data" class="search-section" style="max-width: 600px; gap: 16px;">
            <p>Selecione uma montadora e envie um √≠cone personalizado (PNG/JPG/WebP). Se n√£o houver √≠cone, ser√° usado o padr√£o em <code>static/images/logos/</code>.</p>

            <div class="search-field" style="width:100%;">
                <label for="montadora-select">Montadora:</label>
                <select id="montadora-select" style="min-width: 260px;">
                    {% for m in montadoras %}
                        <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="search-field" style="display:flex; align-items:center; gap:16px;">
                <div>
                    <div style="font-weight:600; margin-bottom:6px;">√çcone atual</div>
                    <img id="montadora-icon-preview" src="" alt="Pr√©via do √≠cone" style="height:36px; background:#f0f0f0; padding:6px; border-radius:6px; max-width: 200px; object-fit: contain;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600; margin-bottom:6px;">Novo arquivo</div>
                    <input type="file" id="montadora-icon-file" name="" accept="image/*">
                    <small style="display:block; color:#666;">O arquivo ser√° salvo como <code>icon_&lt;slug&gt;.&lt;ext&gt;</code> em uploads.</small>
                </div>
            </div>

            <div>
                <button type="submit" class="button">Salvar √çcone</button>
            </div>
        </form>
    </div>

    <!-- Se√ß√£o de Backup e Restaura√ß√£o -->
    <div class="config-section">
        <h2>Backup e Restaura√ß√£o</h2>
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <div style="flex: 1;">
                <h3 style="margin-top: 0;">Criar Backup</h3>
                <p>Crie uma c√≥pia de seguran√ßa de todo o cat√°logo, incluindo produtos, imagens e configura√ß√µes.</p>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    üìÅ O arquivo ser√° salvo na sua pasta <strong>Downloads</strong>
                </p>
                <a href="{{ url_for('admin.backup') }}" class="button" id="btn-backup" onclick="showBackupLoading(event)">
                    üíæ Fazer Backup Agora
                </a>
                <div id="backup-loading" style="display: none; margin-top: 10px;">
                    <span style="color: #007bff; font-weight: bold;">‚è≥ Criando backup, aguarde...</span>
                    <br>
                    <span style="color: #666; font-size: 0.9em;">Isso pode levar alguns segundos dependendo do tamanho do cat√°logo.</span>
                </div>
            </div>
            <div style="flex: 1; border-left: 2px solid #ddd; padding-left: 20px;">
                <h3 style="margin-top: 0;">Restaurar Backup</h3>
                <form action="{{ url_for('admin.restaurar') }}" method="POST" enctype="multipart/form-data" onsubmit="return confirm('ATEN√á√ÉO: A restaura√ß√£o substituir√° TODOS os dados atuais. Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?');">
                    <p>Restaure o cat√°logo a partir de um arquivo de backup (.zip).</p>
                    <input type="file" name="backup_file" accept=".zip" required style="margin-bottom: 10px;">
                    <button type="submit" class="button" style="background-color: #dc3545;">üîÑ Restaurar Backup</button>
                </form>
            </div>
        </div>
    </div>

<script>
function showBackupLoading(event) {
    const btn = document.getElementById('btn-backup');
    const loading = document.getElementById('backup-loading');
    
    // Mostra indicador de loading
    btn.style.opacity = '0.6';
    btn.style.pointerEvents = 'none';
    btn.textContent = '‚è≥ Criando backup...';
    loading.style.display = 'block';
    
    // Permite que o link funcione normalmente
    // O download vai iniciar e depois esconder o loading
    setTimeout(() => {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        btn.textContent = 'üíæ Fazer Backup Agora';
        loading.style.display = 'none';
    }, 5000);
}
</script>

</div>

<style>
    .config-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }
    .config-section {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    .config-section h2 {
        margin-top: 0;
        border-bottom: 2px solid var(--cor-principal, #ff6600);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .progress-bar-background {
        width: 100%;
        background-color: #e9ecef;
        border-radius: 5px;
        height: 24px;
        overflow: hidden;
    }
    .progress-bar-foreground {
        width: 0%;
        height: 100%;
        background-color: #28a745;
        text-align: center;
        line-height: 24px;
        color: white;
        font-weight: bold;
        transition: width 0.4s ease;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function(){
        // Dados vindos do backend
        const iconsMap = {{ (config.montadora_icons or {}) | tojson | safe }};
        const montadoras = {{ (montadoras or []) | tojson | safe }};

        // Bases para montar URLs
        const uploadsBase = "{{ url_for('uploaded_file', filename='DUMMY') }}".replace('DUMMY','');
        const staticBase = "{{ url_for('static', filename='images/logos/') }}";

        function toSlug(name){
            if(!name) return '';
            return name.toLowerCase().replace(/\s+/g,'-').replace(/--+/g,'-');
        }

        function updatePreviewAndInput(){
            const select = document.getElementById('montadora-select');
            const fileInput = document.getElementById('montadora-icon-file');
            const img = document.getElementById('montadora-icon-preview');
            if(!select || !fileInput || !img) return;
            const nome = select.value || '';
            const slug = toSlug(nome);
            // Atualiza o name do input de arquivo conforme o backend espera
            fileInput.setAttribute('name', 'icon_' + slug);
            // Determina a URL da pr√©via: customizada se existir, sen√£o padr√£o
            const custom = iconsMap && iconsMap[slug];
            const src = custom ? (uploadsBase + custom) : (staticBase + slug + '.png');
            img.src = src;
            img.onerror = function(){ this.style.display='none'; };
            img.onload = function(){ this.style.display='inline-block'; };
        }

        document.addEventListener('DOMContentLoaded', function(){
            if ((montadoras || []).length === 0) return;
            const select = document.getElementById('montadora-select');
            updatePreviewAndInput();
            if (select) select.addEventListener('change', updatePreviewAndInput);
        });
    })();
</script>
{% endblock %}